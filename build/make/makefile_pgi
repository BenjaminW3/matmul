# Compilers
CC		= pgcc
NVCC	= nvcc

include makefile_incl

# Flags
COPTFLAGS	= 
CFLAGS		= $(COMMONFLAGS) $(COPTFLAGS) -m64 -acc -ta=nvidia â€“Minfo=accel -mp=allcores # -march=native PGI compiler may need --enable-cuda=basic
NVCCFLAGS	= $(COMMONFLAGS) -m64 -arch=sm_35 --compiler-options "$(COPTFLAGS) -Wall -fopenmp"

# Print help message
help:
	@echo
	@echo "  To compile, choose one of the following:"
	@echo
	@echo "    make matmul"
	@echo "		builds the tests defined in config.h"
	@echo "    make matmulcu"
	@echo "		builds the tests defined in config.h with support for the CUDA tests"
	@echo "    make matmulmpi"
	@echo "		builds the tests defined in config.h with support for the MPI tests"
	@echo
	@echo "  To clean use:"
	@echo
	@echo "    make clean"
	@echo

clean:
	rm -rf *o $(TARGET) $(TARGETCU) $(TARGETMPI) $(TARGETMPICU)

%.c.o: $(INCLUDES)
%.c.o: $(SOURCEDIR)%.c
	$(CC) $(CFLAGS) $(ADDITIONAL_COMPILER_OPTIONS) -c $< -o $@

%.cu.o: $(INCLUDES)
%.cu.o: $(INCLUDESCU)
%.cu.o: $(SOURCEDIR)%.cu
	$(NVCC) $(NVCCFLAGS) -c $< -o $@

$(TARGET): makefile_incl
$(TARGET): makefile_pgi
$(TARGET): $(OBJ)
	@echo "Link '$@':"
	$(LINK) $(OBJ) $(LIBS) -o $@ $(CFLAGS)

$(TARGETCU): makefile_incl
$(TARGETCU): makefile_pgi
$(TARGETCU): $(OBJ)
$(TARGETCU): $(OBJCU)
	@echo "Link '$@':"
	$(LINK) $(OBJ) $(OBJCU) $(LIBS) $(LIBSCU) -o $@ $(CFLAGS)

$(TARGETMPI): ADDITIONAL_COMPILER_OPTIONS = $(shell mpicc --showme:compile)
$(TARGETMPI): INCLUDES := INCLUDESMPI
$(TARGETMPI): makefile_incl
$(TARGETMPI): makefile_pgi
$(TARGETMPI): $(OBJ)
$(TARGETMPI): $(OBJMPI)
	@echo "Link '$@':"
	$(LINK) $(OBJ) $(OBJMPI) $(LIBS) $(shell mpicc --showme:link) -o $@ $(CFLAGS)

$(TARGETMPICU): ADDITIONAL_COMPILER_OPTIONS = $(shell mpicc --showme:compile)
$(TARGETMPICU): INCLUDES := INCLUDESMPI
$(TARGETMPICU): makefile_incl
$(TARGETMPICU): makefile_pgi
$(TARGETMPICU): $(OBJ)
$(TARGETMPICU): $(OBJMPI)
$(TARGETMPICU): $(OBJCU)
	@echo "Link '$@':"
	$(LINK) $(OBJ) $(OBJMPI) $(OBJCU) $(LIBS) $(LIBSCU) $(shell mpicc --showme:link) -o $@ $(CFLAGS)
